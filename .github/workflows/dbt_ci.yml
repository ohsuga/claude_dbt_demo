name: dbt CI (PR Verification)

on:
  pull_request:
    branches:
      - main
    paths:
      - "models/**"
      - "tests/**"
      - "macros/**"
      - "seeds/**"
      - "snapshots/**"
      - "dbt_project.yml"
      - "packages.yml"
      - "profiles.yml.template"
      - ".github/workflows/**"

permissions:
  contents: read
  pull-requests: write
  id-token: write # OIDC 認証に必須

concurrency:
  group: dbt-ci-pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  dbt-ci:
    runs-on: ubuntu-latest
    environment: ci

    env:
      # Snowflake CLI 接続用 (connection名 'ci' )
      SNOWFLAKE_CONNECTIONS_CI_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
      SNOWFLAKE_CONNECTIONS_CI_USER: ${{ secrets.SNOWFLAKE_USER }}
      SNOWFLAKE_CONNECTIONS_CI_AUTHENTICATOR: 'workload_identity'
      SNOWFLAKE_CONNECTIONS_CI_WORKLOAD_IDENTITY_PROVIDER: 'OIDC'
      SNOWFLAKE_CONNECTIONS_CI_ROLE: ${{ secrets.SNOWFLAKE_ROLE }}
      SNOWFLAKE_CONNECTIONS_CI_WAREHOUSE: ${{ secrets.SNOWFLAKE_WAREHOUSE }}
      SNOWFLAKE_CONNECTIONS_CI_DATABASE: ${{ secrets.SNOWFLAKE_DATABASE }}
      
      # dbt プロファイルが参照する環境変数
      SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
      SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
      SNOWFLAKE_ROLE: ${{ secrets.SNOWFLAKE_ROLE }}
      SNOWFLAKE_WAREHOUSE: ${{ secrets.SNOWFLAKE_WAREHOUSE }}
      SNOWFLAKE_DATABASE: ${{ secrets.SNOWFLAKE_DATABASE }}
      DBT_SCHEMA: "DBT_PR_${{ github.event.pull_request.number }}"
      DBT_PROFILES_DIR: "."

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v6

      - name: Checkout main branch for state comparison
        uses: actions/checkout@v6
        with:
          ref: main
          path: main-branch

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Install dbt
        run: |
          pip install --upgrade pip
          # snowflake-cli は進化が早いため適宜バージョン見直しが望ましい
          pip install "snowflake-cli==3.14.*" "dbt-snowflake==1.11.*"

      - name: Create profiles.yml from template
        run: cp profiles.yml.template profiles.yml

      - name: Install dbt packages (PR)
        run: dbt deps

      - name: Generate state manifest from main branch
        run: |
          cd main-branch
          cp ../profiles.yml.template profiles.yml
          dbt deps
          dbt parse --target prod --profiles-dir .
          cd ..
          mkdir -p state
          cp main-branch/target/manifest.json state/manifest.json

      - name: Create PR schema
        run: |
          snow sql --connection ci -q \
          "CREATE SCHEMA IF NOT EXISTS $SNOWFLAKE_CONNECTIONS_CI_DATABASE.$DBT_SCHEMA"

      - name: Run dbt build (Slim CI)
        id: dbt_build
        run: |
          snow dbt build \
            --connection ci \
            --target ci \
            --select +state:modified+ \
            --exclude test_name:relationships* \
            --defer \
            --state state

      - name: Comment PR with results
        if: always()
        uses: actions/github-script@v8
        with:
          script: |
            const outcome = '${{ steps.dbt_build.outcome }}';
            const emoji = outcome === 'success' ? '✅' : (outcome === 'cancelled' ? '⚪️' : '❌');
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const body = [
              `${emoji} **dbt CI (Slim CI): ${outcome}**`,
              ``,
              `- PR Schema: \`${process.env.DBT_SCHEMA}\``,
              `- State: \`main\` の manifest を使用（--defer）`,
              `- Logs: ${runUrl}`,
            ].join('\n');
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });

      - name: Clean up PR schema
        if: always()
        continue-on-error: true
        run: |
          snow sql --connection ci -q \
          "DROP SCHEMA IF EXISTS $SNOWFLAKE_CONNECTIONS_CI_DATABASE.$DBT_SCHEMA"

      - name: Clean up profiles.yml
        if: always()
        run: rm -f profiles.yml
